name: ğŸ¤– DevFlowFix - Debug Auto-Fix Workflow

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  debug-scan:
    runs-on: ubuntu-latest
    name: ğŸ” Debug Error Scan
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install structlog nvidia-nim-client pytz
      
      - name: ğŸ” Simple error detection
        run: |
          echo "=== Python Files in Repo ==="
          find . -name "*.py" -type f | head -20
          
          echo ""
          echo "=== Test for import errors ==="
          python3 << 'EOF'
          import subprocess
          import sys
          
          # Try to compile test_auto_fix_error.py if it exists
          try:
              with open('test_auto_fix_error.py', 'r') as f:
                  code = f.read()
                  compile(code, 'test_auto_fix_error.py', 'exec')
                  print("âœ… test_auto_fix_error.py compiles OK")
          except FileNotFoundError:
              print("âŒ test_auto_fix_error.py not found")
          except SyntaxError as e:
              print(f"âŒ Syntax error: {e}")
          except Exception as e:
              print(f"âŒ Error: {e}")
          
          # Try importing the test file's dependencies
          try:
              import nonexistent_module
              print("âœ… nonexistent_module imported")
          except ImportError as e:
              print(f"âŒ Import error found: {e}")
          EOF
      
      - name: ğŸš€ Run fix_errors.py with verbose output
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
        run: |
          echo "=== Debug Info ==="
          echo "GITHUB_TOKEN: ${GITHUB_TOKEN:0:10}..."
          echo "NVIDIA_API_KEY: ${NVIDIA_API_KEY:0:10}..."
          echo ""
          echo "=== Running scan-only ==="
          python scripts/fix_errors.py --scan-only --directory . || true
      
      - name: ğŸ“ Debug: List files
        run: |
          echo "=== Root directory ==="
          ls -la | head -20
          echo ""
          echo "=== app/ directory ==="
          ls -la app/ || true
