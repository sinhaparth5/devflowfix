# syntax=docker/dockerfile:1.4
# Enable BuildKit for better caching and zstd compression
# Build with: DOCKER_BUILDKIT=1 docker build --compress .

# Stage 1: Builder
FROM python:3.13-slim-bookworm AS builder

WORKDIR /build

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN groupadd -r appuser && useradd -r -g appuser appuser

# Copy and install dependencies first (better layer caching)
COPY requirements.txt .
RUN pip install --user --no-cache-dir -r requirements.txt && \
    find /root/.local -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true && \
    find /root/.local -type d -name "*.dist-info" -exec rm -rf {}/RECORD {} + 2>/dev/null || true && \
    find /root/.local -name "*.pyc" -delete && \
    find /root/.local -name "*.pyo" -delete && \
    find /root/.local -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true

# Copy app and compile to bytecode (keep .py files for safety)
# Only compile to bytecode for faster startup, but keep source for compatibility
COPY app ./app
RUN python -m compileall -q app/
# Note: Keeping .py files for maximum compatibility
# Bytecode (.pyc) will be used automatically when present

# Stage 2: Runtime - Minimal production image
FROM python:3.13-slim-bookworm

LABEL maintainer="Parth Sinha and Shine Gupta" \
      org.opencontainers.image.title="DevFlowFix" \
      org.opencontainers.image.description="Autonomous AI agent for CI/CD failure remediation" \
      org.opencontainers.image.vendor="Parth Sinha and Shine Gupta"

# Performance and security environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH="/app" \
    PYTHONOPTIMIZE=2 \
    PYTHONHASHSEED=random \
    WEB_CONCURRENCY=4

WORKDIR /app

# Install only runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    libpq5 \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN groupadd -r appuser && useradd -r -g appuser -d /home/appuser appuser \
    && mkdir -p /home/appuser/.local \
    && chown -R appuser:appuser /home/appuser

# Copy installed packages and compiled app from builder
COPY --from=builder --chown=appuser:appuser /root/.local /home/appuser/.local
COPY --from=builder --chown=appuser:appuser /build/app ./app

# Set permissions
RUN chmod -R 555 /home/appuser/.local && chmod -R 555 /app

USER appuser

# Health check for container orchestration
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD python -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/health').read()" || exit 1

EXPOSE 8000

# Add .local/bin to PATH for gunicorn
ENV PATH="/home/appuser/.local/bin:$PATH"

# Use gunicorn config file for dynamic worker scaling
# Set WEB_CONCURRENCY env var to control workers (default: 4)
CMD ["gunicorn", "app.main:app", "--config", "app/gunicorn_conf.py"]
